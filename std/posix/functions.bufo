/*
Functions used in POSIX

They're mostly incomplete, and don't follow the declarations precisely.
Bufo doesn't have access to actual functions and macro declarations,
but we need to define some functions at our best guess.

Usage of any of these functions is highly unsafe and might destroy your
system at any time.
*/

import "../linux.bufo";
import "./structs.bufo";

@os(LINUX) module posix {
    config {
        /* copy+paste from libc.bufo */
        dynamic: "libc.so.6",
        libpath: "/usr/lib/",
        libpath: "/usr/lib64/",
        libpath: "/lib/x86_64-linux-gnu/",
    }

    @extern("stat") func stat(path: &char, Statbuf: &Stat) -> i32;
    @extern("strerror") func strerror(errno: i32) -> &char;
    @extern("fork") func fork() -> i32;
    @extern("execvp") func execvp(name: &char, args: &&char) -> i32;
    @extern("waitpid") func waitpid(pid: Handle, out: &i32, flags: i32) -> i32;
    func WIFSIGNALED(Status: i32) -> bool {
        return (((Status & 127) + 1) / 2) > 0;
    }
    func WIFEXITED(Status: i32) -> bool {
        return WTERMSIG(Status) == 0;
    }
    func WTERMSIG(Status: i32) -> i32 {
        return (Status & 127);
    }
    func WEXITSTATUS(Status: i32) -> i32 {
        return (Status & 65280) / 256;
    }
    @extern("strsignal") func strsignal(signal: i32) -> &char;
    @extern("__errno_location") func __errno_location() -> &i32;
    @extern("readlink") func readlink(pathname: &char, buf: &char, bufsiz: i32) -> i32;

    @extern("mmap") func mmap(addr: Any, length: usize, prot: i32, flags: i32, fd: i32, offset: usize) -> Any;
    @extern("munmap") func munmap(addr: Any, length: usize) -> i32;
    @extern("getpagesize") func getpagesize() -> usize;

    @extern("dlopen") func dlopen(filename: &char, flags: i32) -> Any;
    @extern("dlclose") func dlclose(handle: Any) -> i32;
    @extern("dlerror") func dlerror() -> &char;
    func dlopen(filename: &char, flags: i32) -> Handle {
        return Handle {
            ptr: dlopen(filename, flags) as Any as usize
        };
    }
    @extern("dlsym") func dlsym(handle: Any, symbol: &char) -> Any;
    func dlsym(handle: Handle, symbol: &char) -> Handle {
        return Handle {
            ptr: dlsym(handle.ptr as Any, symbol) as usize
        };
    }
}
